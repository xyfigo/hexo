---
title: 'ORA-00257: 归档程序错误。在释放之前仅限于内部连接'
date: 2019-04-24 20:41:58
tags: Oracle 运维
categories: Technology
---

由于近期全国测绘统计年报进入集中上报阶段，造成数据库压力过大，且频繁的数据读写造成数据库归档日志增长非常快，月初才清理的归档日志空间已满，造成数据库报错。

错误提示：`ORA-00257: 归档程序错误。在释放之前仅限于内部连接 `

Oracle数据库版本：`Oracle 11g R2`

这是Oracle数据库较为常见的一类错误，错误原因是数据库归档日志已满，造成数据库无法提供服务。处理方案就是扩大归档日志空间并且使用RMAN清理已有的归档日志。

操作步骤：

1. 从服务器本地登录数据库：

   ```plsql
   Microsoft Windows [版本 6.1.7601]
   版权所有 (c) 2009 Microsoft Corporation。保留所有权利。
   
   C:\Users\Administrator>sqlplus / as sysdba
   
   SQL*Plus: Release 11.2.0.1.0 Production on 星期三 4月 24 20:10:13 2019
   
   Copyright (c) 1982, 2010, Oracle.  All rights reserved.
   
   连接到:
   Oracle Database 11g Enterprise Edition Release 11.2.0.1.0 - Production
   With the Partitioning, OLAP, Data Mining and Real Application Testing options
   ```

2. 查询归档日志使用情况：

   ```plsql
   SQL> select * from v$recovery_file_dest;
   
   NAME
   --------------------------------------------------------------------------------
   
   SPACE_LIMIT SPACE_USED SPACE_RECLAIMABLE NUMBER_OF_FILES
   ----------- ---------- ----------------- ---------------
   D:\app\Administrator\flash_recovery_area
    1.0737E+10 1.0729E+10                 0             281
   ```

   或

   ```plsql
   select * from v$flash_recovery_area_usage;
   ```

3. 查询归档日志设置大小

   ```plsql
   SQL> show parameter db_recovery_file_dest_size
   
   NAME                                 TYPE        VALUE
   ------------------------------------ ----------- ------------------------------
   db_recovery_file_dest_size           big integer 10G
   ```

4. 扩大归档日志空间设置

   ```plsql
   SQL> alter system set db_recovery_file_dest_size=20G scope=both;
   
   系统已更改。
   ```

5. 确认设置情况

   ```plsql
   SQL> show parameter db_recovery_file_dest_size
   
   NAME                                 TYPE        VALUE
   ------------------------------------ ----------- ------------------------------
   db_recovery_file_dest_size           big integer 20G
   ```

   ```plsql
   SQL> select * from v$recovery_file_dest;
   
   NAME
   --------------------------------------------------------------------------------
   
   SPACE_LIMIT SPACE_USED SPACE_RECLAIMABLE NUMBER_OF_FILES
   ----------- ---------- ----------------- ---------------
   D:\app\Administrator\flash_recovery_area
    2.1475E+10 6496842240                 0             167
   ```

6. 进入RMAN

   ```plsql
   Microsoft Windows [版本 6.1.7601]
   版权所有 (c) 2009 Microsoft Corporation。保留所有权利。
   
   C:\Users\Administrator>rman target /
   
   恢复管理器: Release 11.2.0.1.0 - Production on 星期三 4月 24 20:49:42 2019
   
   Copyright (c) 1982, 2009, Oracle and/or its affiliates.  All rights reserved.
   
   连接到目标数据库: ORL (DBID=1362993468)
   
   RMAN>
   ```

7. 找出状态为expired的归档日志 

   ```plsql
   RMAN>crosscheck   archivelog all;  
   ```

8. 删除3天前的归档日志，腾出有效空间

   ```plsql
   RMAN> DELETE ARCHIVELOG ALL COMPLETED BEFORE 'SYSDATE-3';
   ```

9. 在plsql界面关闭数据库

   ```plsql
   SQL> shutdown abort;
   ORACLE 例程已经关闭。
   ```

10. 启动并装载数据库

    ```plsql
    SQL> startup mount;
    ORACLE 例程已经启动。
    
    Total System Global Area 1732554752 bytes
    Fixed Size                  1378008 bytes
    Variable Size            1065355560 bytes
    Database Buffers          654311424 bytes
    Redo Buffers               11509760 bytes
    数据库装载完毕。
    ```

11. 打开数据库服务

    ```plsql
    SQL> alter database open;
    
    数据库已更改。
    ```

    